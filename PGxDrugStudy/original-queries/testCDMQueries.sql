--SET search_path TO ccae_cdm4; -- CCAE - employer insured
--SET search_path TO mdcd_cdm4; -- MDCD - Medicaid
SET search_path TO mdcr_cdm4; -- MDCR - Medicare supplemental insured
SELECT 
  person_id,
  year_of_birth,
  gender_concept_id,
  gender_source_value
 FROM
  person
 LIMIT 10;


SELECT 
  person_id,
  observation_concept_id,
  observation_date,
  observation_source_value
 FROM
  observation
 LIMIT 10;


------------------------------------------------------------
SET search_path TO mdcr_cdm4; -- MDCR - Medicare supplemental insured

-- Find patients within a selected period (Maybe 3 years, 2009 - 2011) that were incident users of at least one drug in the list. For those patients, calculate the total count of different drugs from the list for which they were incident users in this time window
WITH count_of_distinct_substances_per_person AS (
	SELECT DRUG_EXPOSURE.person_id AS exposed_person_id, COUNT(DISTINCT(CONCEPT_ANCESTOR.ancestor_concept_id)) AS distinct_substance_count
	FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
	WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
	AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE >= DATE '2009-01-01'
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE <= DATE '2012-12-31'
	AND DRUG_EXPOSURE.person_id NOT IN ( --sets up incident use within the given time window
		SELECT DISTINCT(DRUG_EXPOSURE.person_id)
		FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
		WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
		AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
		AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE < DATE '2009-01-01'
		)
	GROUP BY DRUG_EXPOSURE.person_id
)
SELECT COUNT(exposed_person_id) AS person_count, distinct_substance_count 
FROM count_of_distinct_substances_per_person
GROUP BY distinct_substance_count
ORDER BY distinct_substance_count

------------------------------------------------------------
-- who are these people who have 15 incident exposures?
WITH count_of_distinct_substances_per_person AS (
	SELECT DRUG_EXPOSURE.person_id AS exposed_person_id, COUNT(DISTINCT(CONCEPT_ANCESTOR.ancestor_concept_id)) AS distinct_substance_count
	FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
	WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
	AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE >= DATE '2009-01-01'
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE <= DATE '2012-12-31'
	AND DRUG_EXPOSURE.person_id NOT IN ( --sets up incident use within the given time window
		SELECT DISTINCT(DRUG_EXPOSURE.person_id)
		FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
		WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
		AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
		AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE < DATE '2009-01-01'
		)
	GROUP BY DRUG_EXPOSURE.person_id
)
SELECT exposed_person_id, distinct_substance_count 
FROM count_of_distinct_substances_per_person
WHERE distinct_substance_count = 15
GROUP BY distinct_substance_count
ORDER BY distinct_substance_count

--- RESULT in MDCR - Medicare supplemental insured
-- 28318073601 	15
-- 2255197702	15
-- 1079811501	15
-- 2459731201	15
-- 27003957502	15
-- 996629301	15
-- 2315793301	15

-- Drill down on these cases
--SET search_path TO mdcr_cdm4; -- MDCR - Medicare supplemental insured
SELECT DRUG_EXPOSURE.person_id, DRUG_EXPOSURE.drug_exposure_id, DRUG_EXPOSURE.drug_exposure_start_date, DRUG_EXPOSURE.drug_exposure_end_date, 
       DRUG_EXPOSURE.quantity, DRUG_EXPOSURE.days_supply, C1.concept_id, C1.concept_name, CONCEPT_ANCESTOR.ancestor_concept_id, C2.concept_name
FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR, CONCEPT as C1, CONCEPT as C2
WHERE DRUG_EXPOSURE.person_id = 28318073601
AND DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
AND CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
AND DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE >= DATE '2009-01-01'
AND DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE <= DATE '2012-12-31'
AND C1.concept_id = DRUG_EXPOSURE.DRUG_CONCEPT_ID
AND C2.concept_id = CONCEPT_ANCESTOR.ancestor_concept_id

-- 28318073601	726572391	2012-08-21		30	30	722067	Paroxetine 10 MG Oral Tablet	722031	Paroxetine
-- 28318073601	645699618	2011-03-09		30	30	722067	Paroxetine 10 MG Oral Tablet	722031	Paroxetine
-- 28318073601	561220272	2010-12-14		90	90	722071	Paroxetine 20 MG Oral Tablet	722031	Paroxetine
-- 28318073601	726573380	2012-12-14		30	31	725178	Mirtazapine 15 MG Oral Tablet	725131	Mirtazapine
-- 28318073601	645687959	2011-01-25		30	30	725178	Mirtazapine 15 MG Oral Tablet	725131	Mirtazapine
-- 28318073601	561216604	2010-07-26		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	561219129	2010-06-25		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	561217303	2010-05-29		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	561211349	2010-04-27		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	561223889	2010-03-26		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	561225085	2010-02-24		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	561224426	2010-01-26		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482597976	2009-12-29		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482591829	2009-11-18		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482600818	2009-10-10		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482606447	2009-09-12		30	30	739202	Sertraline 25 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	726588256	2012-05-18		30	30	739209	Sertraline 50 MG Oral Tablet	739138	Sertraline
-- 28318073601	726590559	2012-04-19		30	30	739209	Sertraline 50 MG Oral Tablet	739138	Sertraline
-- 28318073601	645695099	2011-09-28		30	30	739209	Sertraline 50 MG Oral Tablet	739138	Sertraline
-- 28318073601	645687621	2011-01-18		90	90	739209	Sertraline 50 MG Oral Tablet	739138	Sertraline
-- 28318073601	561218472	2010-09-14		20	20	739209	Sertraline 50 MG Oral Tablet	739138	Sertraline
-- 28318073601	561210262	2010-08-25		20	20	739209	Sertraline 50 MG Oral Tablet	739138	Sertraline
-- 28318073601	645699666	2011-07-17		30	30	948079	pantoprazole 20 MG Enteric Coated Tablet	948078	pantoprazole
-- 28318073601	726569078	2012-07-05		60	20	1103359	Acetaminophen 325 MG / Tramadol Hydrochloride 37.5 MG Oral Tablet	1103314	Tramadol
-- 28318073601	726569030	2012-03-30		30	30	1539411	Simvastatin 20 MG Oral Tablet	1539403	Simvastatin
-- 28318073601	561220256	2010-08-07		30	30	19019412	Nortriptyline 10 MG Oral Capsule	721724	Nortriptyline
-- 28318073601	645702013	2011-03-01		30	30	19019418	Omeprazole 20 MG Enteric Coated Capsule	923645	Omeprazole
-- 28318073601	561225534	2010-12-08		90	90	19019418	Omeprazole 20 MG Enteric Coated Capsule	923645	Omeprazole
-- 28318073601	645694492	2011-11-29		30	30	19023551	Omeprazole 40 MG Enteric Coated Capsule	923645	Omeprazole
-- 28318073601	645694444	2011-07-06		30	30	19023551	Omeprazole 40 MG Enteric Coated Capsule	923645	Omeprazole
-- 28318073601	482597960	2009-07-27		30	30	19037684	Sertraline 50 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482589828	2009-06-24		30	30	19037684	Sertraline 50 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482600802	2009-05-28		30	30	19037684	Sertraline 50 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482604350	2009-04-27		30	30	19037684	Sertraline 50 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	482602986	2009-01-26		90	90	19037684	Sertraline 50 MG Oral Tablet [Zoloft]	739138	Sertraline
-- 28318073601	726589010	2012-10-01		90	90	19079497	Sertraline 25 MG Oral Tablet	739138	Sertraline
-- 28318073601	561219145	2010-10-02		90	90	19079497	Sertraline 25 MG Oral Tablet	739138	Sertraline
-- 28318073601	645685956	2011-11-01		60	60	19080217	pantoprazole 40 MG Enteric Coated Tablet	948078	pantoprazole
-- 28318073601	645704558	2011-10-01		60	60	19080217	pantoprazole 40 MG Enteric Coated Tablet	948078	pantoprazole
-- 28318073601	645694460	2011-08-26		30	30	19080217	pantoprazole 40 MG Enteric Coated Tablet	948078	pantoprazole
-- 28318073601	645704478	2011-03-02		30	30	19123106	Esomeprazole 40 MG Enteric Coated Capsule [Nexium]	904453	Esomeprazole
-- 28318073601	645688055	2011-11-16		60	20	19134047	Tramadol Hydrochloride 50 MG Oral Tablet	1103314	Tramadol
-- 28318073601	645703743	2011-08-31		60	20	19134047	Tramadol Hydrochloride 50 MG Oral Tablet	1103314	Tramadol
-- 28318073601	645683894	2011-01-19		30	30	40162672	Amitriptyline Hydrochloride 10 MG Oral Tablet	710062	Amitriptyline
-- 28318073601	645702061	2011-07-07		30	30	40163286	Rabeprazole sodium 20 MG Enteric Coated Tablet [Aciphex]	911735	rabeprazole
-- 28318073601	482603037	2009-09-04		30	30	40163286	Rabeprazole sodium 20 MG Enteric Coated Tablet [Aciphex]	911735	rabeprazole
-- 28318073601	726573268	2012-01-30		30	30	40167213	Metoprolol Tartrate 25 MG Oral Tablet	1307046	Metoprolol
-- 28318073601	561217611	2010-11-15		180	90	40167213	Metoprolol Tartrate 25 MG Oral Tablet	1307046	Metoprolol
-- 28318073601	726569014	2012-02-11		30	30	40221901	Acetaminophen 300 MG / Codeine Phosphate 15 MG Oral Tablet	1201620	Codeine
-- 28318073601	726590462	2012-05-10		10	5	40221904	Acetaminophen 300 MG / Codeine Phosphate 30 MG Oral Tablet	1201620	Codeine
-- 28318073601	561223921	2010-12-18		20	7	40221904	Acetaminophen 300 MG / Codeine Phosphate 30 MG Oral Tablet	1201620	Codeine
-- 28318073601	645695083	2011-08-18		30	30	40224875	Doxepin Hydrochloride 10 MG Oral Capsule	738156	Doxepin
-- 28318073601	726589026	2012-12-03		30	30	40231925	Acetaminophen 325 MG / Oxycodone Hydrochloride 5 MG Oral Tablet	1124957	Oxycodone
-- 28318073601	726588109	2012-11-17		25	5	40231925	Acetaminophen 325 MG / Oxycodone Hydrochloride 5 MG Oral Tablet	1124957	Oxycodone
-- 28318073601	726573348	2012-08-15		60	10	40231925	Acetaminophen 325 MG / Oxycodone Hydrochloride 5 MG Oral Tablet	1124957	Oxycodone
-- 28318073601	645685876	2011-03-19		16	3	40231925	Acetaminophen 325 MG / Oxycodone Hydrochloride 5 MG Oral Tablet	1124957	Oxycodone
-- 28318073601	645699264	2011-01-06		30	10	40231925	Acetaminophen 325 MG / Oxycodone Hydrochloride 5 MG Oral Tablet	1124957	Oxycodone


------------------------------------------------------------

-- Find patients within 1/1/2009 - 12/31/2012 that were incident users of at least one drug in the list. Filter those patients to only thos that were 65 OR OLDER at the time of exposure. For those patients, calculate the total count of different drugs from the list for which they were incident users in this time window
WITH count_of_distinct_substances_per_person AS (
	SELECT DRUG_EXPOSURE.person_id AS exposed_person_id, COUNT(DISTINCT(CONCEPT_ANCESTOR.ancestor_concept_id)) AS distinct_substance_count
	FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR, PERSON
	WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
	AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE >= DATE '2009-01-01'
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE <= DATE '2012-12-31'
	AND   DRUG_EXPOSURE.person_id = PERSON.person_id 
	AND   (DATE_PART_YEAR(DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE) - PERSON.year_of_birth >= 65)
	AND DRUG_EXPOSURE.person_id NOT IN ( --sets up incident use within the given time window
		SELECT DISTINCT(DRUG_EXPOSURE.person_id)
		FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
		WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
		AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
		AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE < DATE '2009-01-01'
		)
	GROUP BY DRUG_EXPOSURE.person_id
)
SELECT COUNT(exposed_person_id) AS person_count, distinct_substance_count 
FROM count_of_distinct_substances_per_person
GROUP BY distinct_substance_count
ORDER BY distinct_substance_count


-- RESULTS MDCR
-- 766886	1
-- 492661	2
-- 287292	3
-- 150578	4
-- 73298	5
-- 32950	6
-- 14102	7
-- 5804	8
-- 2235	9
-- 842	10
-- 315	11
-- 126	12
-- 41	13
-- 13	14
-- 6	15
-- 2	16


-- Find patients within 1/1/2009 - 12/31/2012 that were incident users of at least one drug in the list. Filter those patients to only thos that were YOUNGER than 65 at the time of exposure. For those patients, calculate the total count of different drugs from the list for which they were incident users in this time window
WITH count_of_distinct_substances_per_person AS (
	SELECT DRUG_EXPOSURE.person_id AS exposed_person_id, COUNT(DISTINCT(CONCEPT_ANCESTOR.ancestor_concept_id)) AS distinct_substance_count
	FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR, PERSON
	WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
	AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE >= DATE '2009-01-01'
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE <= DATE '2012-12-31'
	AND   DRUG_EXPOSURE.person_id = PERSON.person_id 
	AND   ((DATE_PART_YEAR(DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE) - PERSON.year_of_birth) < 65)
	AND DRUG_EXPOSURE.person_id NOT IN ( --sets up incident use within the given time window
		SELECT DISTINCT(DRUG_EXPOSURE.person_id)
		FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
		WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
		AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
		AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE < DATE '2009-01-01'
		)
	GROUP BY DRUG_EXPOSURE.person_id
)
SELECT COUNT(exposed_person_id) AS person_count, distinct_substance_count 
FROM count_of_distinct_substances_per_person
GROUP BY distinct_substance_count
ORDER BY distinct_substance_count


-- RESULTS MDCR
-- 15027	1
-- 10767	2
-- 7257	3
-- 4349	4
-- 2495	5
-- 1221	6
-- 617	7
-- 273	8
-- 123	9
-- 51	10
-- 20	11
-- 6	12
-- 3	13
-- 2	14
-- 1	15


------------------------------------------------------------

-- Find patients within 1/1/2009 - 12/31/2012 that were incident users
-- ACCORDING TO IN OR OUTPATIENT CLAIMS of at least one drug in the
-- list. Filter those patients to only those that were 65 OR OLDER and
-- were receiving care in an INPATIENT HOSPITAL at the time of
-- exposure. For those patients, calculate the total count of
-- different drugs from the list for which they were incident users in
-- this time window
WITH count_of_distinct_substances_per_person AS (
	SELECT DRUG_EXPOSURE.person_id AS exposed_person_id, COUNT(DISTINCT(CONCEPT_ANCESTOR.ancestor_concept_id)) AS distinct_substance_count
	FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR, PERSON, VISIT_OCCURRENCE
	WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
	AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE >= DATE '2009-01-01'
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE <= DATE '2012-12-31'
	AND   DRUG_EXPOSURE.person_id = PERSON.person_id 
	AND   ((DATE_PART_YEAR(DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE) - PERSON.year_of_birth) >= 65)
	AND   DRUG_EXPOSURE.VISIT_OCCURRENCE_ID = VISIT_OCCURRENCE.VISIT_OCCURRENCE_ID
	AND   VISIT_OCCURRENCE.PLACE_OF_SERVICE_CONCEPT_ID = 9202 -- Outpatient visit
	AND DRUG_EXPOSURE.person_id NOT IN ( --sets up incident use within the given time window
		SELECT DISTINCT(DRUG_EXPOSURE.person_id)
		FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
		WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
		AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
		AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE < DATE '2009-01-01'
		)
	GROUP BY DRUG_EXPOSURE.person_id
)
SELECT COUNT(exposed_person_id) AS person_count, distinct_substance_count
FROM count_of_distinct_substances_per_person
GROUP BY distinct_substance_count
ORDER BY distinct_substance_count

-- RESULT MDCR
-- 15686	1
-- 2759	2
-- 91	3



-- a similar query that groups exposures by care site
WITH count_of_distinct_substances_per_person AS (
	SELECT DRUG_EXPOSURE.person_id AS exposed_person_id, COUNT(DISTINCT(CONCEPT_ANCESTOR.ancestor_concept_id)) AS distinct_substance_count, 
	       VISIT_OCCURRENCE.PLACE_OF_SERVICE_CONCEPT_ID AS place_of_service
	FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR, PERSON, VISIT_OCCURRENCE
	WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
	AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE >= DATE '2009-01-01'
	AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE <= DATE '2012-12-31'
	AND   DRUG_EXPOSURE.person_id = PERSON.person_id 
	AND   ((DATE_PART_YEAR(DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE) - PERSON.year_of_birth) >= 65)
	AND   DRUG_EXPOSURE.VISIT_OCCURRENCE_ID = VISIT_OCCURRENCE.VISIT_OCCURRENCE_ID
	AND DRUG_EXPOSURE.person_id NOT IN ( --sets up incident use within the given time window
		SELECT DISTINCT(DRUG_EXPOSURE.person_id)
		FROM DRUG_EXPOSURE, CONCEPT_ANCESTOR
		WHERE DRUG_EXPOSURE.DRUG_CONCEPT_ID = CONCEPT_ANCESTOR.descendant_concept_id
		AND   CONCEPT_ANCESTOR.ancestor_concept_id IN (19024063,19055982,19059796,19010652,19035344,19056756,19010886,1201620,1549786,1124957,1539403,1103314,923645,739138,1307046,715939,797617,904453,929887,948078,743670,722031,710062,715259,1310149,1322184,1167322,911735,1346823,1597756,757688,721724,742185,955632,725131,735979,950637,738156,785788,740275,740910,1436678,778268,19014878,1354860,766529,1436650,1762711,716968,1353256,1337620,798834,1714165,1367268,1736971,1797155,1714277,800878,1437379,705755,1502855)
		AND   DRUG_EXPOSURE.DRUG_EXPOSURE_START_DATE < DATE '2009-01-01'
		)
	GROUP BY DRUG_EXPOSURE.person_id, place_of_service
)
SELECT COUNT(exposed_person_id) AS person_count, distinct_substance_count, place_of_service 
FROM count_of_distinct_substances_per_person
GROUP BY distinct_substance_count, place_of_service 
ORDER BY distinct_substance_count



-- Learn about care sites - we see that place of service concept id is from the CDM while place_of_service_source_value is from http://www.cms.gov/Medicare/Coding/place-of-service-codes/Place_of_Service_Code_Set.html 
select * from care_site, concept where care_site.place_of_service_source_value = 13 AND concept.concept_id = care_site.place_of_service_concept_id LIMIT 10;


-- Learn about visit codes
select * from concept where concept_id in (9201, 9202, 9203);

-- RESULTS
-- 9201	Inpatient Visit	2	Visit	24	IP	1970-01-01	2099-12-31	
-- 9202	Outpatient Visit	2	Visit	24	OP	1970-01-01	2099-12-31	
-- 9203	Emergency Room Visit	2	Visit	24	ER	1970-01-01	2099-12-31	
